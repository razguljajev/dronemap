{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Drone Map Replay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="{% static 'map/mapbox-gl.js' %}"></script>
    <link href="{% static 'map/mapbox-gl.css' %}" rel="stylesheet">
    <style>
        #map-container {
            position: relative;
            height: 100vh;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .map-button {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }
        #start-replay { top: 10px; left: 10px; }
        #pause-replay { top: 10px; left: 120px; }
        #stop-replay { top: 10px; left: 220px; }
        #scroll-bar {
            position: absolute;
            bottom: 50px;
            left: 10px;
            width: 300px;
            z-index: 10;
        }
        #drone-selection {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #data-display {
            position: absolute;
            top: 150px;
            right: 10px;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>

        <!-- Drone Selection Dropdowns -->
        <div id="drone-selection">
            <label for="drone-select1">Select Drone 1 (mandatory):</label>
            <select id="drone-select1" onchange="fetchDroneData(this.value, 'drone1')">
                <option value="">--Select a drone--</option>
            </select>

            <label for="drone-select2">Select Drone 2 (optional):</label>
            <select id="drone-select2" onchange="selectDrone(this, 'drone-select1')">
                <option value="">--Select a drone--</option>
            </select>
        </div>

        <button id="start-replay" class="map-button" onclick="startReplay()">Start Replay</button>
        <button id="pause-replay" class="map-button" onclick="pauseReplay()">Pause Replay</button>
        <button id="stop-replay" class="map-button" onclick="stopReplay()">Stop Replay</button>
        <input type="range" id="scroll-bar" min="0" max="100" value="0" step="1" onchange="updateFromScrollBar()">

        <!-- Data Display -->
        <div id="data-display">
            <p id="distance"></p>
            <p id="altitude-diff"></p>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'xxx'; 
        var map = new mapboxgl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    osm: {
                        type: 'raster',
                        tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
                    }
                },
                layers: [{
                    id: 'osm',
                    type: 'raster',
                    source: 'osm',
                }],
            }
        });

        var replayData1 = [];
        var replayData2 = [];
        var currentIndex = 0;
        var replayInterval = null;
        var dronePoint1, dronePoint2;
        var lineLayer = null;

        // Fetch the available drones and populate the dropdowns
        function fetchAvailableDrones() {
            fetch('/map/api/drones/')
                .then(response => response.json())
                .then(drones => {
                    const droneSelect1 = document.getElementById('drone-select1');
                    const droneSelect2 = document.getElementById('drone-select2');

                    drones.forEach(drone => {
                        const option1 = document.createElement('option');
                        option1.value = drone.id;
                        option1.text = drone.name;
                        droneSelect1.appendChild(option1);

                        const option2 = document.createElement('option');
                        option2.value = drone.id;
                        option2.text = drone.name;
                        droneSelect2.appendChild(option2);
                    });
                })
                .catch(error => console.error('Error fetching drones:', error));
        }

        // Initialize the map and fetch available drones
        fetchAvailableDrones();

        // Function to handle drone selection
        function selectDrone(selectedDropdown, otherDropdownId) {
            const selectedId = selectedDropdown.value;
            const otherDropdown = document.getElementById(otherDropdownId);

            // If a drone is selected, disable it in the other dropdown
            for (let i = 0; i < otherDropdown.options.length; i++) {
                const option = otherDropdown.options[i];
                if (option.value === selectedId) {
                    option.disabled = true;
                } else {
                    option.disabled = false;
                }
            }

            // Fetch data for Drone 2 if it's selected
            if (selectedDropdown.id === 'drone-select2' && selectedId) {
                fetchDroneData(selectedId, 'drone2'); // Fetch data for Drone 2
            }
        }

        // Fetch the drone data based on the selected drone ID
        function fetchDroneData(droneId, droneType) {
            if (!droneId) return;

            // Check if both drones are selected
            const droneSelect1 = document.getElementById('drone-select1');
            const droneSelect2 = document.getElementById('drone-select2');
            const drone2Id = droneSelect2.value;

            // Construct the fetch URL based on whether Drone 2 is selected
            let fetchUrl = `/map/api/replay/${droneId}/`;
            if (drone2Id) {
                fetchUrl += `${drone2Id}/`; // Append Drone 2 ID if selected
            }

            fetch(fetchUrl)
                .then(response => response.json())
                .then(data => {
                    // Store the fetched data based on drone type
                    if (droneType === 'drone1') {
                        replayData1 = data.drone1.features; // Assuming your API returns data in this format
                    } 
                    if (droneType === 'drone2') {
                        replayData2 = data.drone2.features; // Same assumption
                    }

                    // Update scroll bar max value based on both drone data
                    document.getElementById('scroll-bar').max = Math.max(replayData1.length, replayData2.length) - 1;

                    initializeDronePoints();
                    if (droneType === 'drone1') startReplay(); // Start replay if Drone 1 is selected
                })
                .catch(error => console.error('Error fetching drone data:', error));
        }

        function initializeDronePoints() {
            if (!dronePoint1) {
                dronePoint1 = new mapboxgl.Marker({ color: '#FF0000', scale: 1.5 })
                    .setLngLat([0, 0])
                    .addTo(map);
            }

            if (!dronePoint2) {
                dronePoint2 = new mapboxgl.Marker({ color: '#0000FF', scale: 1.5 })
                    .setLngLat([0, 0])
                    .addTo(map);
            }
        }

        function updateDronePositions(coords1, coords2) {
            if (coords1) dronePoint1.setLngLat(coords1);
            if (coords2) dronePoint2.setLngLat(coords2);

            if (coords1 && coords2) {
                drawLineBetweenDrones(coords1, coords2);
            } else {
                removeLine();
            }
        }

        function drawLineBetweenDrones(coords1, coords2) {
            if (lineLayer) {
                map.removeLayer('drone-line');
                map.removeSource('drone-line-source');
            }

            map.addSource('drone-line-source', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': [coords1, coords2]
                    }
                }
            });

            map.addLayer({
                'id': 'drone-line',
                'type': 'line',
                'source': 'drone-line-source',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#888',
                    'line-width': 2
                }
            });

            lineLayer = 'drone-line';
        }

        function removeLine() {
            if (lineLayer) {
                map.removeLayer('drone-line');
                map.removeSource('drone-line-source');
                lineLayer = null;
            }
        }

        function startReplay() {
            const droneSelect1 = document.getElementById('drone-select1');

            if (!droneSelect1.value) {
                alert("Please select at least Drone 1 to start the replay.");
                return;
            }

            if (replayInterval) clearInterval(replayInterval);
            replayInterval = setInterval(updateReplay, 1000);
        }

        function pauseReplay() {
            if (replayInterval) clearInterval(replayInterval);
        }

        function stopReplay() {
            if (replayInterval) clearInterval(replayInterval);
            currentIndex = 0;
            updateDronePositions(replayData1[currentIndex]?.geometry.coordinates, replayData2[currentIndex]?.geometry.coordinates);
        }

        function updateReplay() {
            if (currentIndex >= Math.max(replayData1.length, replayData2.length)) {
                clearInterval(replayInterval);
                return;
            }

            const coords1 = replayData1[currentIndex]?.geometry.coordinates;
            const coords2 = replayData2[currentIndex]?.geometry.coordinates;

            updateDronePositions(coords1, coords2);

            const distance = calculateDistance(coords1, coords2);
            const altitudeDiff = calculateAltitudeDiff(replayData1[currentIndex], replayData2[currentIndex]);

            updateDisplay(distance, altitudeDiff);

            currentIndex++;
            document.getElementById('scroll-bar').value = currentIndex;
        }

        function calculateDistance(coords1, coords2) {
            if (!coords1 || !coords2) return 0;

            const R = 6371000; // Radius of Earth in meters
            const [lng1, lat1] = coords1;
            const [lng2, lat2] = coords2;

            const dLat = toRadians(lat2 - lat1);
            const dLng = toRadians(lng2 - lng1);

            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.sin(dLng / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        function calculateAltitudeDiff(droneData1, droneData2) {
            if (!droneData1 || !droneData2) return 0;
            return Math.abs(droneData1.properties.altitude - droneData2.properties.altitude);
        }

        function toRadians(degrees) {
            return degrees * Math.PI / 180;
        }

        function updateDisplay(distance, altitudeDiff) {
            document.getElementById('distance').textContent = `Distance: ${distance.toFixed(2)} meters`;
            document.getElementById('altitude-diff').textContent = `Altitude Difference: ${altitudeDiff} meters`;
        }

        function updateFromScrollBar() {
            currentIndex = document.getElementById('scroll-bar').value;
            updateReplay();
        }
    </script>
</body>
</html>
